{% load static %}
{% block me %}
<div>
  <div id="txtDate">

  </div>

  <div id="logged-in-users">
    <input type="hidden" id="currentUserImg" name="currentUserImg" value="">
    <input type="hidden" id="currentUser" name="currentUser" value="">
    <input type="hidden" id="senderPacket" name="sender" value="">
    <hr />
    <h4>Contacts</h4>
    {% if users %}
    <ul class="user-list2">
      {% for u in users %}
      <li class="in">
        <div class="logged-in-cont">

          <button id="{{u}}" class="bs-modal btn btn-primary" type="button" name="button"  data-name="{{u}}" data-profile="{{u.profile.avatar.url}}" data-form-url="{% url 'accounts:messenger' %}">
            <img  src="{{u.profile.avatar.url}}" /><i class="fas fa-circle"></i>{{u}}</button>
          <span style="visibility: hidden" id="time-{{forloop.counter}}" value="{{u.last_login}}">{{u.last_login|date:"m/d/Y H:i:s" }}</span>


        </div>
        <span class="online-duration" id="endtime-{{forloop.counter}}" value="{{u.last_login}}"></span>
      </li>
      {% endfor %}
    </ul>
    {% endif %}
    <hr />
    {% if users %}
    {% for x in all_users2 %}
    <ul class="user-list">
      <li style="color: grey">
        <!-- Create book button -->
        <div class="logged-in-cont">
          <button class="create-book{{forloop.counter}} " class="bs-modal btn btn-primary" type="button" name="button" data-form-url="{% url 'dialogs_detail' x %}">
            <img src="{{x.profile.avatar.url}}" />{{x}}<i class="fas fa-bed"></i></button>
        </div>
      </li>
    </ul>

    {% endfor %}
    {% endif %}

    {% if users %}

    <ul class="user-list">

      <li class="current-time" style="color: yellow">
        {{ s }}
        {{x}}

    </ul>

    {% endif %}
  </div>

  {% endblock %}
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="{% static 'js/jquery.bootstrap.modal.forms.js' %}"></script>
  <!-- You can alternatively load the minified version -->
  <script src="{% static 'js/jquery.bootstrap.modal.forms.min.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.28.0/moment.min.js" integrity="sha512-Q1f3TS3vSt1jQ8AwP2OuenztnLU6LwxgyyYOG1jgMW/cbEMHps/3wjvnl1P3WTrF3chJUWEoxDUEjMxDV8pujg==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/scrollmonitor/1.2.0/scrollMonitor.js" integrity="sha512-v86kDQswhXScAMjk6us0nNLSjzER5GLLwPz9BGK24YC8WcNZxU9+ojW32e6sRSkdZlJrvsKOZzFwysAXwHmIPw==" crossorigin="anonymous"></script>
  <script type="text/javascript">
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });
    var $cu = $('#current-user').text();
    var ajaxSucceeded = false;
    // setInterval(function() {
    format_time = function() {
      $('.online-duration').each(function(index, value) {
        // less that 24 hours.
        var $start = $(`#time-${index+1}`).text();
        // var $createEnd = moment()
        // var $end = moment($createEnd).format("MM/DD/YYYY hh:mm:ss")
        // var $duration = moment.utc(moment($end).diff(moment($start))).format("HH:mm")
        let $minutes = moment().diff(moment($start), 'minutes');
        let $days = moment().diff(moment($start), 'days');
        let $hours = moment().diff(moment($start), 'hours');

        if ($hours === 0) {
          $(`#endtime-${index+1}`).text($minutes + " minutes"); // curent time
        } else if ($hours >= 0 && $days <= 1) {
          $(`#endtime-${index+1}`).text($hours + " Hours"); // curent time
        } else if ($days >= 2) {
          $(`#endtime-${index+1}`).text($days + " Days");
        }
      });
    };
    var childImg = "foo";
    $.ajax({
      url: window.location.pathname,
      type: 'GET',
      data: {
        action: 'online_offline'
      },
      success: function(data) {
        ajaxSucceeded = true;
        // grab the inner html of the returned div
        // so you don't nest a new div#refresh-this-div on every call
        var html = $(data).find('#logged-in-users').html();
        $('#logged-in-users').html(html);

        if ($('body').hasClass('modal-open')) {
          $(".in").each(function() {
            if ($(this).is(":contains('" + cu + "')")) {
              $(this).remove();

            } else {
              return false;
            }
            format_time();
            return true;
          });


        } else {
          format_time();
          $(".in").each(function() {
            if ($(this).is(":contains('" + $cu + "')")) {
              $(this).remove();
              console.log($cu);
            }
          });
          $(".bs-modal").each(function() {
            $(this).modalForm({
              formURL: $(this).data('form-url')

            });
            $(this).click(function(){
               var childImg =  $(this).data('profile');
               var userName =  $(this).data('name');
              $("#currentUserImg").val(childImg);
              $("#currentUser").val(userName);

            })
          });

        }

      },
      error: function(data) {
        console.log("error");
        console.log(data);
      }

    })

    // }, 50000)

  </script>
